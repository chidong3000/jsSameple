(function(n){function s(i){n("#txt-cst-name").val(i.name);n("#txt-cst-phone").val(i.phone);n("#cbo-cst-identity-type").val(i.identityType);n("#txt-cst-identity-no").val(i.identityNo);n("#btn-register-bank").attr("data-cst-id",i.id);n("#btn-register-service").attr("data-cst-id",i.id);t.cstregId=i.id;u(!0);n("#btn-check-customer").removeClass("display-none").addClass("display-none");n("#step-2").removeClass("display-none")}function u(t){t||(t=!1);n("#btn-check-customer").removeClass("display-none").addClass("display-none");n("#txt-cst-name").prop("disabled",t);n("#txt-cst-phone").prop("disabled",t);n("#cbo-cst-identity-type").prop("disabled",t);n("#txt-cst-identity-no").prop("disabled",t)}function h(){n("#step-1").find("table").removeClass("display-none").addClass("display-none");n("#step-1").find(".msg").html("");n("#step-1").each(function(){n(this).find("input").val("")});n("#step-2").removeClass("display-none").addClass("display-none");n("#step-2").find(".msg").html("");n("#step-3").removeClass("display-none").addClass("display-none");n("#step-3").find(".msg").html("");n("#step-4").removeClass("display-none").addClass("display-none");n("#step-4").find(".msg").html("");n("#step-4-2").removeClass("display-none").addClass("display-none");n("#step-4-2").find(".msg").html("");n("#step-5").removeClass("display-none").addClass("display-none");n("#step-5").find(".msg").html("");n("#step-5").each(function(){n(this).find("div.evn-info").removeClass("display-none").addClass("display-none")});n("#step-5-2").removeClass("display-none").addClass("display-none");n("#step-5-2").find(".msg").html("");n("#step-6").removeClass("display-none").addClass("display-none");n("#step-6").find(".msg").html("");n("#step-6-1").removeClass("display-none").addClass("display-none");n("#step-7").removeClass("display-none").addClass("display-none")}function c(){n("#step-1, #step-2, #step-3, #step-4, #step-5, #step-6, #step-7, #step-8").each(function(){n(this).find("input").val("");n(this).find("label.lbl-data").html("");n(this).find("select").find("option:eq(0)").prop("selected",!0)})}function i(){n("#step-5").each(function(){n(this).find("input").val("");n(this).find("label.lbl-data").html("");n(this).find("select").find("option:eq(0)").prop("selected",!0);n(this).find("div.evn-info").removeClass("display-none").addClass("display-none")})}function l(){n("#step-7").each(function(){n(this).find("input").val("");n(this).find("label.lbl-data").html("");n(this).find("select").find("option:eq(0)").prop("selected",!0)});n("#btn-payinto").removeClass("display-none").addClass("display-none");n("#btn-paywaiting").removeClass("display-none").addClass("display-none");n("#btn-print").removeClass("display-none").addClass("display-none")}function a(){n("#step-7").each(function(){n(this).find("input.lbl-data").val("");n(this).find("label.lbl-data").html("")});n("#btn-payinto").removeClass("display-none").addClass("display-none");n("#btn-paywaiting").removeClass("display-none").addClass("display-none");n("#btn-print").removeClass("display-none").addClass("display-none")}function v(){var t=n("#cboProduct").val();f(t)}function f(t){var i=n("#cboPeriodType");i.html("");isEmpty(t)===!1&&n.ajax({dataType:"json",url:"/Dictionary/GetTermByProductId",data:{productId:t},success:function(r){if(r&&r.success===!0){var u=r.data;i.append(n("<option><\/option>").val("").html(defaultSelect));n.each(u,function(t,r){i.append(n("<option><\/option>").val(r.code).html(r.name))});y(t)}}})}function y(t){var i=n("#cboDiscountType");i.html("");isEmpty(t)===!1&&n.ajax({dataType:"json",url:"/Dictionary/GetDiscountTypeByProductId",data:{productId:t},success:function(t){if(t&&t.success===!0){var r=t.data;n.each(r,function(t,r){i.append(n("<option><\/option>").val(r.code).html(r.name))})}}})}function p(t,i){n.ajax({dataType:"html",type:"get",url:"/PayInto/PrintInvoicePayInto",data:{transType:t,id:i},success:function(t){n("#data-invoice").html("").html(t);n("#data-invoice").print({globalStyles:!1,mediaPrint:!1,stylesheet:"/css/print-invoice.css",iframe:!1,noPrintSelector:".avoid-this",prepend:"",append:"",deferred:n.Deferred().done(function(){location.reload()})})}})}function w(t){var i=n("#step-1"),r,f,u;t&&t.length>0?(r=2,f=myDataTable(i.find("table"),r),n.each(t,function(t,i){var o=i.cstRegId,r=i.customerName?i.customerName:"",u=i.customerPhone?i.customerPhone:"",s=i.customerIdentityType?i.customerIdentityType:"",h=i.customerIdentityTypeName?i.customerIdentityTypeName:"",e=i.customerIdentityNo?i.customerIdentityNo:"",c=i.isOutBank?i.isOutBank:"",l=`<tr>
                                <td class="text-center">${t+1}</td>
                                <td class="text-left">${r}</td>
                                <td class="text-left">${h}</td>
                                <td class="text-center">${e}</td>
                                <td class="text-center">${u}</td>
                                <td class="text-center">${formatDate(i.regDate)}</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-secondary btn-select-customer" title="Chọn"
                                        data-id='${o}'
                                        data-name='${r}'
                                        data-phone='${u}'
                                        data-identity-type='${s}'
                                        data-identity-no='${e}'
                                        data-isOutBank='${c}'>
                                    <i class="far fa-check-circle"></i> Chọn</button>
                                </td>
                            </tr>`;f.row.add(n(l)).draw()}),i.find("table").removeClass("display-none"),u=i.find(".dataTables_wrapper .row .dataTables_paginate").parent().parent(),u.removeClass("display-none"),t.length<=r&&u.addClass("display-none")):(i.find("table").removeClass("display-none").addClass("display-none"),i.find("table tbody").html(""))}function b(t){var i=n("#step-4");i.find("table tbody").html("");i.removeClass("display-none");i.find(".msg").html("");n("#step-4-2").removeClass("display-none").addClass("display-none");u(!0);t&&t!=="0"?n.ajax({url:"/PayInto/GetCustomerRegisted",type:"get",dataType:"json",data:{id:t},success:function(t){var r,u,e,f;t&&t.success===!0&&(r=t.data,r.length>0?(u=3,e=myDataTable(i.find("table"),u),n.each(r,function(t,i){var r=i.productName?i.productName:"",u=i.peCode?i.peCode:"",f=i.peName?i.peName:"",o=i.peAddress?i.peAddress:"",s=formatDate(i.registerDate),h=formatNumber(i.amount),c=i.periodName?i.periodName:"",l=formatNumber(i.periodAmount),a=i.refNo?i.refNo:"",v=`<tr>
                                                <td class="text-center">${t+1}</td>
                                                <td class="text-left">${r}</td>
                                                <td class="text-left">${u}</td>
                                                <td class="text-left">${f}</td>
                                                <td class="text-left">${o}</td>
                                                <td class="text-center">${s}</td>
                                                <td class="text-right">${h}</td>
                                                <td class="text-center">${c}</td>
                                                <td class="text-right">${l}</td>
                                                <td class="text-center">${a}</td>
                                            </tr>`;e.row.add(n(v)).draw()}),f=i.find(".dataTables_wrapper .row .dataTables_paginate").parent().parent(),f.removeClass("display-none"),r.length<=u&&f.addClass("display-none")):i.find(".msg").html("").html('<p class="text-danger"><strong>Khách hàng hiện chưa có hợp đồng<\/strong><\/p>'))},error:function(n){console.log(n.responseText)}}):i.find(".msg").html("").html('<p class="text-danger"><strong>Khách hàng hiện chưa có hợp đồng<\/strong><\/p>')}function r(t){var i=n("#step-4-2");i.find("table tbody").html("");i.removeClass("display-none");i.find(".msg").html("");n("#step-5").removeClass("display-none").addClass("display-none");n("#step-5-2").removeClass("display-none").addClass("display-none");n("#btn-save-bank, #btn-update-bank button").attr({"data-id":t});t&&t!=="0"?n.ajax({url:"/SearchBank/GetCustomerSearchBank",type:"get",dataType:"json",data:{id:t},success:function(r){var u,f,o,e;r&&r.success===!0&&(u=r.data,u.length>0?(f=5,o=myDataTable(i.find("table"),f),n.each(u,function(i,r){var u=r.cstBankId?r.cstBankId:"",f=r.bankCode?r.bankCode:"",v=r.bankName?r.bankName:"",y=r.bankAccTypeName?r.bankAccTypeName:"",c=r.bankAccType?r.bankAccType:"",e=r.bankAccType?r.accountNo:"",p=formatDate(r.regDate),s=r.status?r.status:"",w=r.statusName?r.statusName:"",h=r.isDefault?r.isDefault:"",b=h==="1"?"checked":"",l="",a;s==="P"&&(l="disabled");a=`<tr>
                                                <td class="text-center">${i+1}</td>
                                                <td class="text-center">${f}</td>
                                                <td class="text-center">${v}</td>
                                                <td class="text-center">${y}</td>
                                                <td class="text-center">${e}</td>
                                                <td class="text-center">${p}</td>
                                                <td class="text-center">${w}</td>
                                                <td class="text-center">
                                                    <input type="radio" class="rdo-isDefault"
                                                        data-id='${t}'
                                                        data-cstBankId='${u}'
                                                        data-cstBankId='${u}'
                                                        data-bankCode='${f}'
                                                        data-bankAccType='${c}'
                                                        data-accountNo='${e}'
                                                        data-status='${s}'
                                                        data-isDefault='${h}'
                                                    ${b} ${l}>
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm btn-secondary btn-select-bank" title="Chi tiết"
                                                        data-id='${t}'
                                                        data-cstBankId='${u}'
                                                        data-bankCode='${f}'
                                                        data-bankAccType='${c}'
                                                        data-accountNo='${e}'
                                                        data-status='${s}'
                                                        data-isDefault='${h}'>
                                                    <i class="far fa-check-circle"></i> Chi tiết</button>
                                                </td>
                                            </tr>`;o.row.add(n(a)).draw()}),e=i.find(".dataTables_wrapper .row .dataTables_paginate").parent().parent(),e.removeClass("display-none"),u.length<=f&&e.addClass("display-none")):i.find(".msg").html("").html('<p class="text-danger"><strong>Không có ngân hàng<\/strong><\/p>'))},error:function(n){console.log(n.responseText)}}):i.find(".msg").html("").html('<p class="text-danger"><strong>Không có ngân hàng<\/strong><\/p>')}var t={},e=n("#frm-check-customer"),o=n("#frm-bank");n(document).ready(function(){e.validate();o.validate();v();n.validator.addMethod("regex",function(n,t,i){return this.optional(t)||i.test(n)},"Please check your input.");n('input[name="FilterValue"]').keypress(function(t){var i=t.which;return i===13?(n("#btn-search-customer").click(),!1):!0});n(document).on("change","#cboFilter",function(){var t=n(this).val();n("#frm-search-customer").validate();n("#cboFilter").rules("remove","required");n("#cboFilter").rules("add",{required:!0,messages:{required:"Vui lòng chọn"}});t==="CMND"?(n("#txt-filter").rules("remove","validIdCitizen"),n("#txt-filter").rules("remove","validPassport"),n("#txt-filter").rules("remove","validEvn"),n("#txt-filter").rules("add",{required:!0,validIdCard:!0,messages:{required:"Vui lòng nhập"}})):t==="CCCD"?(n("#txt-filter").rules("remove","validIdCard"),n("#txt-filter").rules("remove","validPassport"),n("#txt-filter").rules("remove","validEvn"),n("#txt-filter").rules("add",{required:!0,validIdCitizen:!0,messages:{required:"Vui lòng nhập"}})):t==="PASSPORT"?(n("#txt-filter").rules("remove","validIdCard"),n("#txt-filter").rules("remove","validIdCitizen"),n("#txt-filter").rules("remove","validEvn"),n("#txt-filter").rules("add",{required:!0,validPassport:!0,messages:{required:"Vui lòng nhập"}})):t==="EVN"?(n("#txt-filter").rules("remove","validIdCard"),n("#txt-filter").rules("remove","validIdCitizen"),n("#txt-filter").rules("remove","validPassport"),n("#txt-filter").rules("add",{required:!0,validEvn:!0,messages:{required:"Vui lòng nhập"}})):(n("#txt-filter").rules("remove","validIdCard"),n("#txt-filter").rules("remove","validIdCitizen"),n("#txt-filter").rules("remove","validPassport"),n("#txt-filter").rules("remove","validEvn"),n("#txt-filter").rules("add",{required:!0,messages:{required:"Vui lòng nhập"}}))});n(document).on("change","#cbo-cst-identity-type",function(){var i=n(this).val(),r=n(this),t=n("#txt-cst-identity-no");r.rules("remove","required");r.rules("add",{required:!0,messages:{required:"Vui lòng chọn"}});i==="CMND"?(t.rules("remove","validIdCitizen"),t.rules("remove","validPassport"),t.rules("remove","validEvn"),t.rules("add",{required:!0,validIdCard:!0,messages:{required:"Vui lòng nhập"}})):i==="CCCD"?(t.rules("remove","validIdCard"),t.rules("remove","validPassport"),t.rules("remove","validEvn"),t.rules("add",{required:!0,validIdCitizen:!0,messages:{required:"Vui lòng nhập"}})):i==="PASSPORT"?(t.rules("remove","validIdCard"),t.rules("remove","validIdCitizen"),t.rules("remove","validEvn"),t.rules("add",{required:!0,validPassport:!0,messages:{required:"Vui lòng nhập"}})):(t.rules("remove","validIdCard"),t.rules("remove","validIdCitizen"),t.rules("remove","validPassport"),t.rules("remove","validEvn"),t.rules("add",{required:!0,messages:{required:"Vui lòng nhập"}}))});n(document).on("change","#cbo-bank",function(){var r=n(this).val(),t=n("#cbo-bank-acc-type"),i=n("#txt-bank-acc-no");isEmpty(r)===!0?(t.rules("remove","required"),i.rules("remove","required")):(t.rules("remove","required"),t.rules("add",{required:!0,messages:{required:"Vui lòng chọn"}}),i.rules("remove","required"),i.rules("add",{required:!0,messages:{required:"Vui lòng nhập"}}))});n(document).on("change","#cboProduct",function(){var t=n(this).val();f(t);l()});n(document).on("click","#btn-search-customer",function(){h();c();var t=n("#frm-search-customer");return(t.validate({rules:{Filter:{required:!0},FilterValue:{required:!0}},messages:{Filter:{required:"Vui lòng chọn"},FilterValue:{required:"Vui lòng nhập"}}}),t.valid()===!0)?(n("#btn-register-customer").removeClass("display-none"),n.ajax({url:"/PayInto/GetCustomerList",type:"get",dataType:"json",data:{filter:n("select[name='Filter']").val(),filterValue:n.trim(n("input[name='FilterValue']").val())},success:function(t){if(t&&t.success===!0){var i=t.data;w(i);i.length>0?n("#step-1").find(".msg").html(""):n("#step-1").find(".msg").html("").html('<p class="text-danger"><strong>Không có KH nào thỏa điều kiện tìm kiếm<\/strong><\/p>')}else n("#step-1").find("table tbody").html(""),n("#step-1").find("table").removeClass("display-none").addClass("display-none"),n("#step-1").find(".msg").html("").html(`<p class="text-danger"><strong>${t.message}</strong></p>`)},error:function(n){console.log(n.responseText)}}),!0):!1});n(document).on("click",".btn-select-customer",function(){var t=n(this),u={id:t.attr("data-id"),name:t.attr("data-name"),phone:t.attr("data-phone"),identityType:t.attr("data-identity-type"),identityNo:t.attr("data-identity-no"),isOutBank:t.attr("data-isOutBank")},i;s(u);i=t.attr("data-id");b(i);r(i)});n(document).on("input","#bankAccountNo",function(){var t=n(this),i=t[0].selectionStart;n(this).val(function(n,t){return t.toUpperCase()});t[0].selectionStart=t[0].selectionEnd=i});n(document).on("click","#step-4-2 .btn-select-bank",function(){n("#step-5").removeClass("display-none");n("#btn-update-bank").removeClass("display-none");var t=n(this),i=t.attr("data-id"),r=t.attr("data-cstBankId"),f=t.attr("data-bankCode"),e=t.attr("data-bankAccType"),o=t.attr("data-accountNo"),u=t.attr("data-status"),s=t.attr("data-isDefault");i&&i!=="0"?(n("#btn-save-bank").attr({"data-id":i,"data-cstBankId":r,"data-status":u,"data-isDefault":s}),n("#btn-update-bank button").attr({"data-id":i,"data-cstBankId":r}),n("#bankCode").val(f),n("#bankAccType").val(e),n("#bankAccountNo").val(o),n("#btn-update-bank button").removeClass("display-none"),n("#btn-update-bank button[data-status='"+u+"']").addClass("display-none")):n("#step-5").find(".msg").html("").html('<p class="text-danger"><strong>Không có thông tin ngân hàng<\/strong><\/p>')});n(document).on("click","#step-4-2 .rdo-isDefault",function(){var u=n(this),f=u.attr("data-id"),e=u.attr("data-cstBankId"),o=u.attr("data-bankCode"),s=u.attr("data-bankAccType"),h=u.attr("data-accountNo"),c=u.attr("data-status");t.cstRegId=f;t.bank={};t.bank.bankCode=o;t.bank.bankAccType=s;t.bank.accountNo=h;t.bank.cstBankId=e;t.bank.status=c;t.bank.isDefault="1";n.ajax({url:"/SearchBank/RegisterSearchBank",type:"post",dataType:"json",data:t,success:function(n){n&&n.success===!0?(i(),r(f),notifySuccess("Cập nhật tài khoản ngân hàng mặc định thành công")):notifyDanger(n.message)}}).always(function(){})});n(document).on("click","#btn-update-bank button",function(){var u=n(this),e=u.attr("data-id"),s=u.attr("data-cstBankId"),f=u.attr("data-status"),h=u.attr("data-isDefault"),o=n("#form-reg-bank");return(o.validate({rules:{BankCode:{required:!0},BankAccType:{required:!0},BankAccountNo:{required:!0,regex:/^[A-Z0-9]{16,25}$/}},messages:{BankCode:{required:"Vui lòng chọn"},BankAccType:{required:"Vui lòng chọn"},BankAccountNo:{required:"Vui lòng nhập",regex:"Vui lòng nhập đúng định dạng"}}}),o.valid()===!0)?(t.cstRegId=e,t.isOutBank=n("#isOutBank").is(":checked")?"1":"0",t.bank={},t.bank.bankCode=n.trim(n("#bankCode").val()),t.bank.bankAccType=n.trim(n("#bankAccType").val()),t.bank.accountNo=n.trim(n("#bankAccountNo").val()),t.bank.cstBankId=s,t.bank.status=f,t.bank.isDefault=h,n.ajax({url:"/SearchBank/RegisterSearchBank",type:"post",dataType:"json",data:t,success:function(n){if(n&&n.success===!0){i();r(e);var t=n.message;f=="A"&&(t="Đăng ký lại tài khoản thành công");f=="P"&&(t="Ngừng sử dụng tài khoản thành công");notifySuccess(t)}else notifyDanger(n.message)}}).always(function(){}),!0):!1});n(document).on("click","#btn-register-bank",function(){i();n("#step-5-2").addClass("display-none");n("#step-5").removeClass("display-none");n("#btn-save-bank").attr({"data-cstBankId":"","data-status":"","data-isDefault":""});n("#btn-update-bank").addClass("display-none")});n(document).on("click","#btn-save-bank",function(){var u=n(this),f=u.attr("data-id"),o=u.attr("data-cstBankId"),s=u.attr("data-status"),h=u.attr("data-isDefault"),e=n("#form-reg-bank");return(e.validate({rules:{BankCode:{required:!0},BankAccType:{required:!0},BankAccountNo:{required:!0,regex:/^[A-Z0-9]{16,25}$/}},messages:{BankCode:{required:"Vui lòng chọn"},BankAccType:{required:"Vui lòng chọn"},BankAccountNo:{required:"Vui lòng nhập",regex:"Vui lòng nhập đúng định dạng"}}}),e.valid()===!0)?(t.cstRegId=f,t.isOutBank=n("#isOutBank").is(":checked")?"1":"0",t.bank={},t.bank.bankCode=n.trim(n("#bankCode").val()),t.bank.bankAccType=n.trim(n("#bankAccType").val()),t.bank.accountNo=n.trim(n("#bankAccountNo").val()),t.bank.cstBankId=o,t.bank.status=s,t.bank.isDefault=h,n.ajax({url:"/SearchBank/RegisterSearchBank",type:"post",dataType:"json",data:t,success:function(n){n&&n.success===!0?(i(),r(f),notifySuccess("Lưu thành công")):notifyDanger(n.message)}}).always(function(){}),!0):!1});n(document).on("click","#btn-print",function(){var t=n(this),i=t.attr("data-id"),r=t.attr("data-trans-type");p(r,i)});n(document).on("click","#btn-refresh",function(){n.confirm({title:"Xác nhận?",content:"Bạn muốn làm mới?",type:"red",typeAnimated:!0,buttons:{tryAgain:{text:"Đồng ý",btnClass:"btn-red",action:function(){location.reload()}},close:{text:"Hủy",action:function(){}}}})});n(document).on("change","#txt-paymentAmt, #cboPeriodType, #cboDiscountType, input[name='DiscountPay']",function(){a()})})})(jQuery);