function calculator(n,t,i,r,u,f,e){if(ClearData(),e==="0"){notifyDanger("Tài khoản ví không tồn tại");return}if(formatNumber(t)<=0){notifyDanger("Không đủ số dư để thực hiện giao dịch");return}$("#txtMoneyInOutAmt").focus();$("#txtAllowAmount").val(formatNumber(t));$("#txtFeeAmount").val(0);$("#txtAmountAfter").val();$("#txtRefNo").val(i);$("#txtPeCode").val(n);$("#txtProduct").val(r);$("#txtProductName").val(u);$("#txtScheduleId").val(f);$("#pnlDetail").removeAttr("hidden");$("#btnMaster").removeAttr("hidden");$(location).attr("href","#pnlDetail")}function cal(n){var t,i,r;if(n.value.length>12||!$.isNumeric(n.value.replace(/[^0-9-]+/g,""))){notifyDanger("Số bạn nhập không hợp lệ");$("#txtMoneyInOutAmt").val("");$("#txtAmountAfter").val("");return}if(t=$("#txtAllowAmount").val().replace(/[^0-9-]+/g,""),(t===null||t==="")&&(t=0),parseInt(n.value)<1e4){notifyDanger("Vui lòng nhập số tiền lớn hơn 10.000 vnđ");$("#txtMoneyInOutAmt").val("");$("#txtAmountAfter").val("");return}if(i=$("#txtFeeAmount").val(),i||(i=0),r=parseInt(t)-parseInt(n.value.replace(/[^0-9-]+/g,""))-i,r<0){notifyDanger("Bạn không thể rút số tiền vượt quá hạn số dư");$("#txtMoneyInOutAmt").val("");$("#txtAmountAfter").val("");$("#txtAmountString").text("");return}$("#txtAmountAfter").val(formatNumber(r));ReadMoney(n.value)}function bindCustomerList(n){var t,i;backToStep1();t=$(".mvc-grid-pager-rows").val();n||(n=1);t||(t=10);$("#lblNotExist").text("");$("#lblEdongNotExist").text("");i={pageNo:n,pageSize:t,filter:$("#cboFilter").val(),para:$("#txt-filter").val()};$.ajax({url:"/MoneyInOut/GetCustomerInfo",type:"post",dataType:"html",data:i,success:function(n){if(n.trim().length>0){$("#divlblNotExist").attr("hidden",!0);$("#divlblEdongNotExist").attr("@ViewBag.Hidden",!1);var t=$(n);$("#step-1").html(t);$("#step-1").show()}else $("#divlblNotExist").removeAttr("hidden"),$("#lblNotExist").text("Không tồn tại khách hàng nào"),$("#cusInfo").html(""),$("#step-1").empty(),$("#btnMaster").attr("hidden",!0)}})}function bindCustomerOverview(n){var t={cstRegId:n};$.ajax({url:"/MoneyInOut/CustomerOverviewPartial",type:"post",dataType:"html",data:t,success:function(n){if(n.trim().length>0){$("#divlblNotExist").attr("hidden",!0);$("#divlblEdongNotExist").attr("@ViewBag.Hidden",!1);var t=$(n);$("#step-2-1").html(t);$("#step-2-1").show()}else $("#divlblNotExist").removeAttr("hidden"),$("#lblNotExist").text("Không có dữ liệu"),$("#cusInfo").html(""),$("#step-2-1").empty(),$("#btnMaster").attr("hidden",!0)}})}function bindMoneyOut(){var n=$("#overview").data("overview"),t={cstRegId:n.CusRegOverview.cstRegId,accountDMD:n.CusRegOverview.accountDMD};$.ajax({url:"/MoneyInOut/MoneyOutInfo",type:"post",dataType:"json",data:t,success:function(n){var t,i,u,r;n!==null?(t=0,$("#divlblNotExist").attr("hidden",!0),$("#divlblEdongNotExist").attr("@ViewBag.Hidden",!1),$("#money-out-amt-allowed").val(formatNumber(n.balAmt)),i=n.balAmt>t?t:0,$("#money-out-amt").val(formatNumber(i)),u=AutoNumeric.getAutoNumericElement("#money-out-amt"),u.rawValue=i,$("#otp-value").val(""),ReadMoney($("#money-out-amt")),$("#money-out-fee").val(formatNumber(n.feeAmt)),r=n.balAmt-n.feeAmt-t,$("#money-out-amt-allowed-after").val(formatNumber(r>0?r:0)),$("#btn-money-out-bill").prop("disabled",!1),$("#btn-print-money-out-bill").prop("disabled",!0)):($("#divlblNotExist").removeAttr("hidden"),$("#lblNotExist").text("Không có dữ liệu"))}})}function ReadMoney(n){var t=0,i=$(n).val();try{t=i.replace(/[^0-9-]+/g,"")}catch(r){t=0}$.ajax({url:"/MoneyInOut/ReadMoney",type:"post",dataType:"json",data:{amt:i.replace(/[^0-9-]+/g,"")},success:function(i){var r=i;$("#"+$(n).attr("id")+"-string").text(r);$(n).val(formatNumber(t))}})}function printWithdraw(n,t,i){$.ajax({dataType:"html",type:"post",url:"/MoneyInOut/PrintWithdraw",data:{id:n,type:t,beginAmt:i},success:function(n){$("#data-withdraw-info").html("").html(n);$("#data-withdraw-info").print({globalStyles:!1,mediaPrint:!1,stylesheet:"/css/print-invoice.css",iframe:!1,noPrintSelector:".avoid-this",prepend:"",append:"",deferred:$.Deferred().done(function(){location.reload()})})}})}function validateMoneyOutForm(){var t=parseInt($("#money-out-amt-allowed").val().replace(/[^0-9-]+/g,"")),i=parseInt($("#money-out-amt").val().replace(/[^0-9-]+/g,"")),r=parseInt($("#money-out-fee").val().replace(/[^0-9-]+/g,"")),n;return t-i-r<0?(notifyDanger("Số dư không đủ."),!1):(n=parseInt($("#money-out-amt").val().replace(/[^0-9-]+/g,"")),n%1e3!=0||n<1e4)?(notifyDanger("Số tiền rút tối thiểu là 10.000 và số tiền phải tròn nghìn."),$("#money-out-amt").focus(),!1):$.trim($("#otp-value").val())===""?(notifyDanger("Vui lòng nhập mã xác thực"),$("#otp-value").focus(),!1):!0}function validateMoneyInForm(){if(parseInt($("#money-in-amt").val().replace(/[^0-9-]+/g,""))<=0)return notifyDanger("Vui lòng nhập số tiền"),$("#money-in-amt").focus(),!1;var n=parseInt($("#money-in-amt").val().replace(/[^0-9-]+/g,""));return n%1e3!=0||n<1e4?(notifyDanger("Số tiền tối thiểu là 10.000 và số tiền phải tròn nghìn."),$("#money-in-amt").focus(),!1):!0}function validateMoneyInWaitingForm(){var n,t,i;return $("#money-in-amt").val()!==""&&$("#money-in-amt").val()!=="0"&&(n=parseInt($("#money-in-amt").val().replace(/[^0-9-]+/g,"")),n%1e3!=0||n<1e4)?(notifyDanger("Số tiền tối thiểu là 10.000 và số tiền phải tròn nghìn."),$("#money-in-amt").focus(),!1):(t=$("#cboBankList").val(),t==="")?(notifyDanger("Vui lòng chọn ngân hàng"),$("#cboBankList").focus(),!1):(i=$("#txt-bank_acc-no").val(),i==="")?(notifyDanger("Vui lòng chọn số tài khoản"),$("#txt-bank_acc-no").focus(),!1):!0}function convertToNum(n){return parseInt(n.replace(/[^0-9-]+/g,""))}function ClearData(){$("#txtMoneyInOutAmt").val("");$("#txtAllowAmount").val("");$("#txtFeeAmount").val(0);$("#txtAmountAfter").val("");$("#txtRefNo").val("");$("#txtPeCode").val("");$("#txtProduct").val("");$("#txtProductName").val("");$("#txtAmountString").text("");$("#txt-otp").val("");$("#txtScheduleId").val("")}function backToStep1(){$("#step-1").hide();$("#step-2").hide();$("#step-2-1").hide();$("#step-3").hide();$("#step-3-1").hide()}function submitMoneyOut(){var n=$("#overview").data("overview"),t={customerCode:n.CusRegOverview.cstRegId,phone:$("#txt-cst-phone").val(),allowAmt:convertToNum($("#money-out-amt-allowed").val()),feeAmt:convertToNum($("#money-out-fee").val()),totalAmtDue:convertToNum($("#money-out-amt").val()),availableAmt:convertToNum($("#money-out-amt-allowed-after").val()),sender:n.CusRegOverview.accountDMD,verifyCode:$("#otp-value").val()};$.ajax({url:"/MoneyInOut/MoneyOut",type:"post",dataType:"json",data:t,success:function(n){n.success?($("#btn-money-out-bill").prop("disabled",!0),$("#btn-print-money-out-bill").prop("disabled",!1),$("#btn-print-money-out-bill").data("id",n.data.regId),$("#otp-value").val(""),notifySuccess("Rút tiền thành công.")):notifyDanger(n.message)},error:function(n){console.log(n.responseText)}})}function submitMoneyIn(){var n=$("#overview").data("overview"),t={cstRegId:n.CusRegOverview.cstRegId,receiver:n.CusRegOverview.accountDMD,amt:convertToNum($("#money-in-amt").val()),transType:"I",bankCode:null,bankAccNo:null};$.ajax({url:"/MoneyInOut/MoneyIn",type:"post",dataType:"json",data:t,success:function(n){n.success?($("#btn-money-in-bill").prop("disabled",!0),$("#btn-money-in-waiting").prop("disabled",!0),$("#btn-print-money-in-bill").data("id",n.data.regId),$("#btn-print-money-in-bill").prop("disabled",!1),notifySuccess(n.message)):notifyDanger(n.message)},error:function(n){console.log(n.responseText)}})}function submitMoneyInWaiting(){var n=$("#overview").data("overview"),t=0,i;t=$("#money-in-amt").val()===""||parseInt($("#money-in-amt").val().replace(/[^0-9-]+/g,""))<0?0:convertToNum($("#money-in-amt").val());i={cstRegId:n.CusRegOverview.cstRegId,receiver:n.CusRegOverview.accountDMD,amt:t,transType:"W",bankCode:$("#cboBankList").val(),bankAccNo:$("#txt-bank_acc-no").val()};$.ajax({url:"/MoneyInOut/MoneyInWaiting",type:"post",dataType:"json",data:i,success:function(n){n.success?($("#btn-money-in-bill").prop("disabled",!0),$("#btn-money-in-waiting").prop("disabled",!0),$("#btn-print-money-in-bill").prop("disabled",!0),notifySuccess(n.message)):notifyDanger(n.message)},error:function(n){console.log(n.responseText)}})}function bindGrid(n,t,i,r){var u,f;n||(n=1);u=$("#overview").data("overview");f={pageNo:n,pageSize:5,isPaging:1,cstRegId:u.CusRegOverview.cstRegId};$.ajax({url:i,type:"post",dataType:"html",data:f,success:function(n){if(n.trim().length>0){var i=$(n);t.html(i);t.show()}else notifyInfo(r)}})}function loadBanks(){$("#cboBankList").html("");$("#txt-bank_acc-no").val("");$.ajax({dataType:"json",url:"/Dictionary/GetBanksEcp",data:{},success:function(n){if(n&&n.success===!0){var t=n.data;$("#cboBankList").append($("<option><\/option>").val("").html(defaultSelect));$.each(t,function(n,t){$("#cboBankList").append($(`<option data-name='${t.bankAccNo}'></option>`).val(t.bankCode).html(t.bankName))});setBankName()}}})}function setBankName(){$("#txt-bank_acc-no").val($("#cboBankList option:selected").attr("data-name"))}var uiLibrary="bootstrap4",$postData=$("#post-data"),dialog1,grid,contractCancelRegPostData={},dataCus;$(document).ready(function(){$('input[name="FilterValue"]').keypress(function(n){var t=n.which;return t===13?($("#btn-search-cust").click(),!1):!0});$("#btn-quit").on("click",function(){window.location.href="Home"});$("#btn-search-cust").on("click",function(n){ClearData();var t=$("#cboFilter").val(),i=$("#txt-filter").val();if(t===null||t===""){notifyDanger("Vui lòng chọn điều kiện cần tìm");return}if(i===null||i===""){notifyDanger("Vui lòng nhập điều kiện cần tìm");$("#txt-filter").focus();return}if(t==="CMND"&&!$.isNumeric(i)){notifyDanger("Vui lòng nhập số cho CMND");return}$("#pnlDetail").attr("hidden",!0);$("#btnMaster").attr("hidden",!0);$("#step-4").removeClass("display-none").addClass("display-none");n.preventDefault();bindCustomerList()});$(document).on("click","#btn-get-otp",function(){var i=dataCus.id,r=dataCus.cusAreacode,u=dataCus.cusBranchcode,f=$.trim($("#txt-cst-phone").val()),n=$.trim($("#money-out-amt").val()),t=parseInt($("#money-out-amt").val().replace(/[^0-9-]+/g,"")),e=parseInt($("#money-out-amt-allowed").val().replace(/[^0-9-]+/g,"")),o=parseInt($("#money-out-amt").val().replace(/[^0-9-]+/g,"")),s=parseInt($("#money-out-fee").val().replace(/[^0-9-]+/g,""));if(e-o-s<0)return notifyDanger("Số dư không đủ."),!1;if(t%1e3!=0||t<1e4)return notifyDanger("Số tiền rút tối thiểu là 10.000 và số tiền phải tròn nghìn."),$("#money-out-amt").focus(),!1;if(isEmpty(n)||convertToNum(n)<=0){$("#money-out-amt").focus();notifyDanger("Vui lòng nhập số tiền rút");return}$.ajax({url:"/otp/RequestOtp",type:"get",dataType:"json",data:{phone:f,customerCode:i,areaCode:r,branchCode:u},success:function(n){n.success===!1?notifyDanger(n.message):notifyInfo("Đã gửi OTP")},error:function(n){console.log(n.responseText)}})});$(document).on("click","#btn-save",function(){var i=$.trim($("#txtPhone").val()),r=$.trim($("#txtRefNo").val()),u=$.trim($("#txtAmountString").text()),n=$.trim($("#txt-otp").val()),t=$.trim($("#txtMoneyInOutAmt").val()).replace(/[^0-9-]+/g,"");t=formatNumber(item.amount);var f=$.trim($("#txtAmountAfter").val()).replace(/[^0-9-]+/g,""),e=$.trim($("#txtAllowAmount").val()).replace(/[^0-9-]+/g,""),o=$.trim($("#txtPeCode").val()),s=$.trim($("#txtProduct").val()),h=$.trim($("#txtFullName").val()),c=$.trim($("#txtPhone").val()),l=$.trim($("#txtCmnd").val()),a=$.trim($("#cbo-cst-identity-type").val()),v=$.trim($("#txtScheduleId").val());if(isEmpty(n)){notifyDanger("Vui lòng nhập OTP");$("#txt-otp").focus();return}if(isEmpty(t)){notifyDanger("Vui lòng nhập số tiền rút");$("#txtMoneyInOutAmt").focus();return}if(n.length>8){notifyDanger("Vui lòng nhập OTP tối đa 8 chử số");$("#txt-otp").focus();return}$.ajax({url:"/otp/AuthOtp",type:"get",dataType:"json",data:{otpCode:n,phone:i,contractNo:r},success:function(y){if(y.success===!1){notifyDanger(y.message);return}var p={phone:i,refCode:r,peCode:o,productCode:s,totalAmtDue:t,allowAmt:e,feeAmt:"0",availableAmt:f,totalAmtDueText:u,verifyCode:n,payementMethod:"COD",custPhone:c,custName:h,custIdentify:l,custIdentifyType:a,scheduleId:v};$.ajax({url:"/MoneyInOut/SaveMoneyInOut",type:"post",dataType:"json",data:p,success:function(n){n.success===!0?($("#txtResponeData").val(n.data),$("#btn-save").prop("disabled",!0),$("#btn-print").prop("disabled",!1),$.alert({title:"Thông báo thành công",content:"Rút tiền thành công",type:"green",typeAnimated:!0,buttons:{ok:{text:"Đồng ý",btnClass:"btn-green",keys:["enter","shift"],action:function(){}}}})):notifyDanger(n.message)}})},error:function(n){notifyDanger("Lỗi OTP: "+n.responseText);console.log(n.responseText)}})});$(document).on("click","#btn-print",function(){$("#txtResponeData").val()!==""&&printMoneyInOut($("#txtResponeData").val())});$(document).on("click",".btn-select-customer",function(){var n=$(this).data();dataCus=n;contractCancelRegPostData.phone=n.phone;$("#txt-cst-name").val(n.name);$("#txt-cst-phone").val(n.phone);$("#cbo-cst-identity-type").val(n.identityType);$("#txt-cst-identity-no").val(n.identityNo);$("#step-2").show();$("#step-3").hide();$("#step-3-1").hide();$("#step-4").removeClass("display-none").addClass("display-none");bindCustomerOverview(n.id)});$(document).on("blur","#money-in-amt",function(){var n=$("#overview").data("overview"),t=n.CusBillOverview.totalAmtNotPay;ReadMoney($(this))});$(document).on("blur","#money-out-amt",function(){var n=parseInt($("#money-out-amt-allowed").val().replace(/[^0-9-]+/g,"")),t=parseInt($("#money-out-amt").val().replace(/[^0-9-]+/g,"")),i=parseInt($("#money-out-fee").val().replace(/[^0-9-]+/g,""));if(n-t-i<0){notifyDanger("Số dư không đủ.");return}$("#money-out-amt-allowed-after").val(formatNumber(n-t-i));ReadMoney($(this))});$(document).on("click","#btn-money-in",function(){$("#btn-money-out").prop("disabled",!1);$("#btn-money-in").prop("disabled",!0);var n=$("#overview").data("overview"),t=parseInt(n.CusBillOverview.totalAmtNotPay),i=parseInt(n.CusRegOverview.balKD),u=parseInt(n.CusRegOverview.balDMD),r=0;i<t&&(r=t-i);$("#money-in-amt-min").val(formatNumber(r));$("#money-in-amt").val(0);$("#btn-money-in-bill").prop("disabled",!1);$("#btn-money-in-waiting").prop("disabled",!1);$("#btn-print-money-in-bill").prop("disabled",!0);ReadMoney($("#money-in-amt"));$("#step-3-1").hide();$("#step-3").show();loadBanks()});$(document).on("change","#cboBankList",function(){setBankName()});$(document).on("click","#btn-money-in-bill",function(){validateMoneyInForm()&&submitMoneyIn()});$(document).on("click","#btn-money-in-waiting",function(){validateMoneyInWaitingForm()&&submitMoneyInWaiting()});$(document).on("click","#btn-print-money-in-bill",function(){var n=$(this).data("id"),t,i;if(n===null||n===""){notifyWarning("Không có giao dịch để in.");return}t=$("#overview").data("overview");i=t.CusRegOverview.balDMD;printWithdraw(n,"i",i)});$(document).on("click","#btn-exit-money-in, #btn-exit-money-out, #btn-exit-contract-cancel",function(){location.reload()});$(document).on("click","#btn-money-out",function(){bindMoneyOut();$("#btn-money-out").prop("disabled",!0);$("#btn-money-in").prop("disabled",!1);$("#btn-money-out-bill").prop("disabled",!1);$("#btn-print-money-out-bill").prop("disabled",!0);ReadMoney($("#money-out-amt"));$("#step-3").hide();$("#step-3-1").show()});$(document).on("click","#btn-money-out-bill",function(){validateMoneyOutForm()&&submitMoneyOut()});$(document).on("click","#btn-print-money-out-bill",function(){var n=$(this).data("id");if(n===null||n===""){notifyWarning("Không có giao dịch để in.");return}printWithdraw(n,"o")});$(document).on("click","#btn-contracts",function(n){n.preventDefault();bindGrid(null,$("#contract-list"),"/MoneyInOut/ContractListPartial","Khách hàng chưa có hợp đồng")});$(document).on("click","#contract-list .grid-pager button",function(n){n.preventDefault();var t=$(this).attr("data-page");bindGrid(t,$("#contract-list"),"/MoneyInOut/ContractListPartial","Khách hàng chưa có hợp đồng")});$(document).on("click","#btn-orders",function(n){n.preventDefault();bindGrid(null,$("#order-list"),"/MoneyInOut/BillListPartial","Khách hàng chưa đăng ký")});$(document).on("click","#order-list .grid-pager button",function(n){n.preventDefault();var t=$(this).attr("data-page");bindGrid(t,$("#order-list"),"/MoneyInOut/BillListPartial","Khách hàng chưa đăng ký")});$(document).on("click","#contractList .btn-select-contract",function(){var t=$(this),n=t.attr("data-contractno"),i=$("#overview").data("overview");n!==""?$.ajax({url:"/MoneyInOut/ContractCancelGet",type:"get",dataType:"json",data:{contractNo:n},success:function(n){if(n&&n.success===!0){var t=n.data.data;contractCancelRegPostData.contractNo=t.contractNo?t.contractNo:"";contractCancelRegPostData.amt=t.amtRemain?t.amtRemain:"0";$("#contractNo-r").val(contractCancelRegPostData.contractNo);$("#periodAmt-r").val(t.periodAmt?formatNumber(t.periodAmt):"0");$("#periodRemain-r").val(t.periodRemain?formatNumber(t.periodRemain):"0");$("#amtRemain-r").val(t.amtRemain?formatNumber(t.amtRemain):"0");$("#commitAmt-r").val(t.commitAmt?formatNumber(t.commitAmt):"0");$("#fee-r").val(t.fee?formatNumber(t.fee):"0");$("#period-r").val(t.period?formatNumber(t.period):"0");$("#discountAmt-r").val(t.discountAmt?formatNumber(t.discountAmt):"0");ReadMoney($("#amtRemain-r"));$("#txt-otp-cancel").val("");$("#step-4").removeClass("display-none")}else notifyDanger(n.message);console.log(n.message)},error:function(n){console.log(n.responseText)}}):notifyDanger("Không có số hợp đồng")});$(document).on("click","#btn-get-otp-cancel",function(){var n=contractCancelRegPostData.phone,t=contractCancelRegPostData.contractNo,f=$("#overview").data("overview"),i=dataCus.id,r=dataCus.cusAreacode,u=dataCus.cusBranchcode;console.log(dataCus);$.ajax({url:"/otp/RequestOtp",type:"get",dataType:"json",data:{phone:n,contractNo:t,templateCode:"OTP_TTTDCKH_HUY",customerCode:i,areaCode:r,branchCode:u},success:function(n){n.success===!1?notifyDanger(n.message):notifyInfo("Đã gửi OTP")},error:function(n){console.log(n.responseText)}})});$(document).on("click","#btn-contract-cancel",function(){var t=contractCancelRegPostData.phone,i=contractCancelRegPostData.contractNo,n=$.trim($("#txt-otp-cancel").val()),r=$("#cbo-cst-pay-type").val();if(isEmpty(n)){notifyDanger("Vui lòng nhập OTP");$("#txt-otp-cancel").focus();return}if(n.length>8){notifyDanger("Vui lòng nhập OTP tối đa 8 chử số");$("#txt-otp-cancel").focus();return}$.ajax({url:"/otp/AuthOtp",type:"get",dataType:"json",data:{otpCode:n,phone:t,contractNo:i},success:function(t){if(t.success===!1){notifyDanger(t.message);return}contractCancelRegPostData.verifyCode=n;contractCancelRegPostData.payType=r;$.ajax({url:"/MoneyInOut/ContractCancelReg",type:"post",dataType:"json",data:contractCancelRegPostData,success:function(n){n.success===!0?($("#txt-otp-cancel").val(""),$("#step-4").removeClass("display-none").addClass("display-none"),$("#btn-contracts").trigger("click"),notifySuccess(n.message)):notifyDanger(n.message)}})},error:function(n){notifyDanger("Lỗi OTP: "+n.responseText);console.log(n.responseText)}})})});